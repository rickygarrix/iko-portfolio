(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4427],{3219:(e,t,s)=>{"use strict";s.d(t,{default:()=>f});var a=s(5155),l=s(2115),r=s(5695),i=s(6072),n=s(3168),o=s(3999),c=s(4943),d=s(3256),u=s(706);let p=async(e,t,s,a,l,r)=>{let i=n.N.from("stores").select("*").eq("is_published",!0);e.length&&(i=i.filter("genre_ids","cs",JSON.stringify(e))),t.length&&(i=i.in("area_id",t)),s.length&&(i=i.overlaps("payment_method_ids",s));let{data:c,error:d}=await i;if(d||!c)throw Error((null==d?void 0:d.message)||"データ取得失敗");let u=c.map(e=>e.id),p={},m={};if("posts"===r){let{data:e}=await n.N.from("posts").select("store_id").in("store_id",u).eq("is_active",!0);null==e||e.forEach(e=>{p[e.store_id]=(p[e.store_id]||0)+1})}if("followers"===r){let{data:e}=await n.N.from("store_follows").select("store_id").in("store_id",u);null==e||e.forEach(e=>{m[e.store_id]=(m[e.store_id]||0)+1})}let{data:h}=await n.N.from("area_translations").select("area_id, name").eq("locale",l),f=Object.fromEntries((null==h?void 0:h.map(e=>[e.area_id,e.name]))||[]),g=c.map(e=>({...e,areaTranslated:f[e.area_id],_postCount:p[e.id]||0,_followerCount:m[e.id]||0}));return"posts"===r&&g.sort((e,t)=>t._postCount-e._postCount),"followers"===r&&g.sort((e,t)=>t._followerCount-e._followerCount),a?g.filter(e=>(0,o.CW)(e.opening_hours).isOpen):g};function m(e){let{selectedGenres:t,selectedAreas:s,selectedPayments:n,showOnlyOpen:m,isSearchTriggered:h,messages:f}=e,g=(0,r.useRouter)(),x=(0,r.useSearchParams)(),_=(0,r.usePathname)(),v=x.toString(),w=_.split("/")[1]||"ja",[S,y]=(0,l.useState)("default"),[N,j]=(0,l.useState)({}),[b,O]=(0,l.useState)(!1),[C,E]=(0,l.useState)(!1),[k,I]=(0,l.useState)(!1),A=(0,l.useRef)(new Set),{data:J,error:P,isLoading:q}=(0,i.Ay)(h?["search-stores",w,S]:null,()=>p(t,s,n,m,w,S),{revalidateOnFocus:!1});(0,l.useLayoutEffect)(()=>{let e=sessionStorage.getItem("searchScrollY");if(e&&_==="/".concat(w,"/search")){let t=parseInt(e,10);E(!0),requestAnimationFrame(()=>{window.scrollTo(0,t),setTimeout(()=>{window.scrollTo(0,t),sessionStorage.removeItem("searchScrollY"),E(!1),I(!0)},0)})}else I(!0)},[_,w]),(0,l.useEffect)(()=>{J&&"ja"!==w&&(async()=>{let e={};for(let t of J)if(t.description)try{let s=await (0,c.s)(t.description,w);e[t.id]=s}catch(s){e[t.id]=t.description}j(e)})()},[J,w]);let T=async e=>{if(!("ja"!==w||A.current.has(e))){A.current.add(e),sessionStorage.setItem("searchScrollY",window.scrollY.toString()),O(!0);try{await (0,o.d5)("click_search_store",{store_id:e,query_params:v,locale:w})}catch(e){}setTimeout(()=>{g.push("/stores/".concat(e,"?prev=/search&").concat(v))},100)}};return h?q?(0,a.jsx)("p",{className:"text-center py-6",children:f.loading}):P?(0,a.jsxs)("p",{className:"text-red-500 text-center py-6",children:["⚠️ ",f.error,": ",P.message]}):J&&0!==J.length?(0,a.jsxs)("div",{className:"relative w-full pb-8 pt-[64px]",style:{visibility:C?"hidden":"visible",minHeight:"100vh"},children:[b&&(0,a.jsx)("div",{className:"fixed inset-0 z-[9999] bg-white/80"}),k&&(0,a.jsxs)("div",{className:"mx-auto max-w-[600px] px-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsxs)("p",{className:"text-lg font-semibold",children:[f.resultLabel," ",(0,a.jsx)("span",{className:"text-[#4B5C9E]",children:J.length})," ",f.items]}),(0,a.jsxs)("select",{value:S,onChange:e=>y(e.target.value),className:"border text-sm rounded px-2 py-1",children:[(0,a.jsx)("option",{value:"default",children:"おすすめ順"}),(0,a.jsx)("option",{value:"posts",children:"投稿数順"}),(0,a.jsx)("option",{value:"followers",children:"フォロワー数順"})]})]}),(0,a.jsx)("div",{className:"flex flex-col items-center gap-4",children:J.map(e=>(0,a.jsx)(d.A,{store:e,locale:w,index:0,genresMap:f.genres,translatedDescription:N[e.id],onClick:T,onMapClick:t=>{var s,a;t.stopPropagation(),(0,u.J)("click_searchresult_map",{store_id:e.id,store_name:e.name,latitude:null!=(s=e.latitude)?s:void 0,longitude:null!=(a=e.longitude)?a:void 0})},messages:f},e.id))})]})]}):(0,a.jsx)("p",{className:"text-center py-6",children:f.notFound}):(0,a.jsx)("p",{className:"text-center py-6",children:f.prompt})}var h=s(4653);function f(e){var t;let{messages:s}=e,c=(0,r.useSearchParams)(),d=null!=(t=null==c?void 0:c.toString())?t:"",[u,p]=(0,l.useState)([]),[f,g]=(0,l.useState)([]),[x,_]=(0,l.useState)([]),[v,w]=(0,l.useState)(!1),[S,y]=(0,l.useState)(!1),N=async(e,t,s,a)=>{let l=n.N.from("stores").select("*").eq("is_published",!0);e.length>0&&(l=l.filter("genre_ids","cs",JSON.stringify(e))),t.length>0&&(l=l.in("area_id",t)),s.length>0&&(l=l.overlaps("payment_method_ids",s));let{data:r,error:i}=await l;return i||!r?0:(a?r.filter(e=>(0,o.CW)(e.opening_hours).isOpen):r).length},{data:j}=(0,i.Ay)(["previewCount",u,f,x,v],e=>{let[,t,s,a,l]=e;return N(t,s,a,l)},{revalidateOnFocus:!1});return(0,l.useEffect)(()=>{var e,t,s,a,l,r;let i=null!=(a=null==c||null==(e=c.get("genre"))?void 0:e.split(","))?a:JSON.parse(sessionStorage.getItem("filterGenres")||"[]"),n=null!=(l=null==c||null==(t=c.get("area"))?void 0:t.split(","))?l:JSON.parse(sessionStorage.getItem("filterAreas")||"[]"),o=null!=(r=null==c||null==(s=c.get("payment"))?void 0:s.split(","))?r:JSON.parse(sessionStorage.getItem("filterPayments")||"[]"),d=(null==c?void 0:c.get("open"))==="true"||JSON.parse(sessionStorage.getItem("filterOpen")||"false");p(i),g(n),_(o),w(d),y(!0)},[d,c]),(0,a.jsx)("div",{className:"min-h-screen flex flex-col bg-white text-gray-800",children:(0,a.jsx)("main",{className:"flex-grow flex justify-center pt-8",children:(0,a.jsxs)("div",{className:"w-full max-w-[1024px] px-4 min-h-[200px]",children:[S&&(0,a.jsx)(l.Suspense,{fallback:(0,a.jsx)("div",{className:"text-center py-10",children:"検索結果を読み込み中..."}),children:(0,a.jsx)(m,{selectedGenres:u,selectedAreas:f,selectedPayments:x,showOnlyOpen:v,isSearchTriggered:S,messages:{...s.searchResults,genres:s.genres}},d)}),(0,a.jsx)(h.A,{messages:s.searchFilter,genres:s.genres,areas:s.areas}),"number"==typeof j&&(0,a.jsxs)("p",{className:"text-xs text-right text-gray-400 mt-4",children:["プレビュー件数：",j," 件"]})]})})})}},8521:(e,t,s)=>{Promise.resolve().then(s.bind(s,3219))}},e=>{var t=t=>e(e.s=t);e.O(0,[851,4212,5561,6072,5576,7991,8441,1684,7358],()=>t(8521)),_N_E=e.O()}]);